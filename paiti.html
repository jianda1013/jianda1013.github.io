<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Painting</title>
    <script src="./js/aLib.js" type="text/javascript">
    </script>
    <link href="./css/prism.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/1475972496.js">
    </script>
    <style type="text/css">
    body,html{widthL100%;height:100%;}
    body{overflow:hidden;}
    #myCanvas{
       position:absolute;
       z-index:300;
    }
    </style>
    <script type="text/javascript">
    function mouseDown(e){
       this.draw=true;
       this.ctx = this.getContext("2d");
       this.ctx.beginPath();
       this.ctx.strokeStyle=document.rossi.pc.value;
       this.ctx.lineWidth=document.rossi.pw.value;

       var o=this;
       this.offsetX=this.offsetLeft;
       this.offsetY=this.offsetTop;

       while(o.offsetParent){
           o=o.offsetParent;
           this.offsetX+=o.offsetLeft;
           this.offsetY+=o.offsetTop;
       }
       this.ctx.moveTo(e.pageX-this.offsetX,e.pageY-this.offsetY-window.scrollY);
    }

    function mouseMove(e){
       if (this.draw){
           this.ctx.lineTo(e.pageX-this.offsetX,e.pageY-this.offsetY-window.scrollY);
           this.ctx.stroke();
       }
    }

    function mouseUp(e){
       this.draw=false;
    }

    function touchStart(e){
       this.draw=true;
       this.ctx=this.getContext("2d");
       this.touch=e.targetTouches[0];
       this.ctx.beginPath();
       this.ctx.strokeStyle=document.rossi.pc.value;
       this.ctx.lineWidth=document.rossi.pw.value;

       var o=this;
       this.offsetX=this.offsetLeft;
       this.offsetY=this.offsetTop;

       while(o.offsetParent){
           o=o.offsetParent;
           this.offsetX+=o.offsetLeft;
           this.offsetY+=o.offsetTop;
       }
       this.ctx.moveTo(this.touch.pageX-this.offsetX,this.touch.pageY-this.offsetY-window.scrollY);
       e.preventDefault();
    }

    function touchMove(e){
       this.touch=e.targetTouches[0];
       if (this.draw){
           this.ctx.lineTo(this.touch.pageX-this.offsetX,this.touch.pageY-this.offsetY-window.scrollY);
           this.ctx.stroke();
       }
       e.preventDefault();
    }

    function touchEnd(e){
       this.ctx.stroke();
       this.draw=false;
       e.preventDefault();
    }

    function clearPad(){
       var canvas=$('#myCanvas');
       var ctx=canvas.getContext("2d");
       ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function saveSign(){
       var canvas=$('#myCanvas');

       var blank = document.createElement('canvas');
       blank.width = canvas.width;
       blank.height = canvas.height;

       if (canvas.toDataURL()!=blank.toDataURL()){
           var dataURL=canvas.toDataURL('image/png');
           document.rossi.dataURL.value=dataURL;

           new Ajax({
               url:'aj_saveSign.asp?ts='+new Date().getTime(),
               method:'post',
               form:document.rossi,
               success:function(xmlhttp,form){
                   form.order.value=xmlhttp.responseText;
                   window.location='http://audi.tw/pad/?'+xmlhttp.responseText;
               }
           });
       }else{
           alert('Canvas is blank');
       }
    }

    window.addEventListener('load',function(){
       var canvas=$('#myCanvas');
       var ctx=canvas.getContext("2d");
       canvas.width=bWidth;
       canvas.height=bHeight;

       canvas.addEventListener('mousedown',mouseDown);
       canvas.addEventListener('mousemove',mouseMove);
       canvas.addEventListener('mouseup',mouseUp);

       canvas.addEventListener('touchstart',touchStart);
       canvas.addEventListener('touchmove',touchMove);
       canvas.addEventListener('touchend',touchEnd);

       var image=window.location.search.substring(1);
       document.rossi.order.value=image;
       document.rossi.url.value='http://audi.tw/pad/?'+image;

       new Ajax({
           url:'aj_readImage.asp?image='+image+'&ts='+new Date().getTime(),
           method:'get',
           success:function(xmlhttp){
               var img=$('img[name="canvas"]');
               img.src=xmlhttp.responseText;
               img.onload=function(){
                   ctx.drawImage(img,0,0,canvas.width,canvas.height);
               }

           }
       });

    });
    </script>
</head>
<body>
    <form class="valign-middle" id="rossi" name="rossi">
        <button class="btn valign-middle" onclick="clearPad();return false;"><i class="fa fa-eraser fa-fw"></i></button> <button class="btn" onclick="saveSign();return false;"><i class="fa fa-floppy-o fa-fw"></i></button> <i class="fa fa-paint-brush"></i> <input class="valign-middle" max="10" min="1" name="pw" onchange="$('#pb').css({width:this.value+'px',height:this.value+'px'});" type="range" value="2"> <span class="inline-block padding-s valign-middle border"></span>
        <div class="bg-black" id="pb" style="width:2px;height:2px;">
            <span class="inline-block padding-s valign-middle border"></span>
        </div><input class="valign-middle" name="pc" type="color" value="#000000"> <input class="width-max valign-middle" name="url" type="text"> <input name="order" type="hidden"> <input name="dataURL" type="hidden">
    </form><img class="hidden" id="canvas" name="canvas">
    <canvas class="border" height="360" id="myCanvas" width="360"></canvas>
</body>
</html>